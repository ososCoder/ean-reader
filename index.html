<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0"
		/>
		<title>EscÃ¡ner EAN - MÃ³vil</title>
		<script src="https://unpkg.com/quagga/dist/quagga.min.js"></script>
		<script src="./service-worker.js"></script>

		<!-- Manifest PWA -->
		<link
			rel="manifest"
			href="manifest.json"
		/>
		<meta
			name="theme-color"
			content="#007bff"
		/>

		<style>
			body {
				font-family: Arial, sans-serif;
				margin: 0;
				background: #f9fafb;
				color: #333;
				display: flex;
				flex-direction: column;
				align-items: center;
			}

			header {
				width: 100%;
				background: #007bff;
				color: white;
				text-align: center;
				padding: 1rem;
				font-size: 1.2rem;
			}

			#scanner {
				width: 100%;
				max-width: 480px;
				height: 220px;
				background: black;
				position: relative;
				overflow: hidden;
			}

			#scanner video,
			#scanner canvas {
				width: 100% !important;
				height: 100% !important;
				object-fit: cover;
				position: absolute;
				top: 0;
				left: 0;
			}

			.content {
				width: 100%;
				max-width: 480px;
				padding: 1rem;
				box-sizing: border-box;
			}

			h3 {
				margin-top: 1rem;
				margin-bottom: 0.5rem;
				font-size: 1.1rem;
			}

			ul {
				list-style: none;
				padding: 0;
				max-height: 180px;
				overflow-y: auto;
				background: white;
				border: 1px solid #ddd;
				border-radius: 8px;
				margin: 0;
			}

			li {
				padding: 10px;
				border-bottom: 1px solid #eee;
				font-size: 1rem;
				cursor: pointer;
				user-select: none;
			}

			li:last-child {
				border-bottom: none;
			}

			li:hover {
				background: #f1f1f1;
			}

			.btn-group {
				display: flex;
				justify-content: space-around;
				margin-top: 1rem;
				gap: 10px;
			}

			button {
				flex: 1;
				padding: 12px;
				font-size: 1rem;
				border: none;
				border-radius: 6px;
				cursor: pointer;
				font-weight: bold;
				transition: background 0.2s;
				z-index: 10;
				position: relative;
			}

			button:active {
				transform: scale(0.97);
			}

			#exportar {
				background: #28a745;
				color: white;
			}
			#exportar:hover {
				background: #218838;
			}

			#reset {
				background: #dc3545;
				color: white;
			}
			#reset:hover {
				background: #c82333;
			}

			.counter {
				margin-top: 0.5rem;
				font-size: 0.9rem;
				color: #555;
			}
		</style>
	</head>
	<body>
		<header>EscÃ¡ner de cÃ³digos EAN</header>

		<div id="scanner"></div>

		<div class="content">
			<h3>Lista de cÃ³digos</h3>
			<p class="counter">
				CÃ³digos escaneados:
				<span id="contador">0</span>
			</p>
			<ul id="lista"></ul>

			<div class="btn-group">
				<button id="exportar">â¬‡ Exportar CSV</button>
				<button id="reset">ðŸ”„ Reiniciar</button>
			</div>
		</div>

		<script>
			const lista = document.getElementById('lista');
			const contador = document.getElementById('contador');
			const codigos = []; // ahora serÃ¡ un array de objetos {codigo, unidades}
			let ultimaLectura = '';

			// Inicializar QuaggaJS
			Quagga.init(
				{
					inputStream: {
						type: 'LiveStream',
						constraints: { facingMode: 'environment' },
						target: document.querySelector('#scanner'),
					},
					decoder: {
						readers: ['ean_reader', 'ean_8_reader', 'upc_reader'],
					},
				},
				function (err) {
					if (err) {
						console.error(err);
						return;
					}
					Quagga.start();
				}
			);

			// Detectar cÃ³digos
			Quagga.onDetected(data => {
				const code = data.codeResult.code;

				// evitar repeticiÃ³n inmediata
				if (code === ultimaLectura) return;
				ultimaLectura = code;

				const confirmar = confirm(
					`Â¿Quieres aÃ±adir el cÃ³digo ${code} a la lista?`
				);
				if (confirmar) {
					let unidades = parseInt(
						prompt(`Â¿CuÃ¡ntas unidades del artÃ­culo ${code}?`),
						10
					);

					if (isNaN(unidades) || unidades <= 0) {
						alert('NÃºmero de unidades no vÃ¡lido. No se aÃ±adirÃ¡.');
						return;
					}

					codigos.push({ codigo: code, unidades });

					const li = document.createElement('li');
					li.textContent = `${code} - Unidades: ${unidades}`;

					// Doble clic para eliminar
					li.addEventListener('dblclick', () => {
						const index = codigos.findIndex(item => item.codigo === code);
						if (index > -1) {
							codigos.splice(index, 1);
							lista.removeChild(li);
							contador.textContent = codigos.length;
						}
					});

					lista.appendChild(li);
					contador.textContent = codigos.length;
				}
			});

			// BotÃ³n reiniciar lista
			document.getElementById('reset').addEventListener('click', () => {
				codigos.length = 0;
				lista.innerHTML = '';
				contador.textContent = '0';
			});

			// BotÃ³n exportar CSV
			document.getElementById('exportar').addEventListener('click', () => {
				if (codigos.length === 0) {
					alert('No hay cÃ³digos para exportar');
					return;
				}

				let csvContent = 'CÃ³digo,Unidades\n';
				codigos.forEach(item => {
					csvContent += `${item.codigo},${item.unidades}\n`;
				});

				const blob = new Blob([csvContent], { type: 'text/csv' });
				const link = document.createElement('a');
				const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
				link.download = `EANs_${timestamp}.csv`;
				link.href = URL.createObjectURL(blob);
				link.click();
			});

			// Registrar service worker
			if ('serviceWorker' in navigator) {
				navigator.serviceWorker
					.register('service-worker.js')
					.then(() => console.log('Service Worker registrado'))
					.catch(err => console.error('Error registrando SW:', err));
			}
		</script>
	</body>
</html>
